<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Work-Life Balance v3.4 (Rescue)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-body: #fbf9f6; --surface: #ffffff;
            --primary: #a89080; --primary-dark: #6d5b50;
            --text-main: #4a403a; --text-sub: #9e948d; --line: #f0ebe5;
            --tag-ot: #f5f0eb; --tag-ot-text: #8c7b70;
            --tag-off: #edf2ed; --tag-off-text: #6b8c6e;
            --radius: 20px; --shadow: 0 4px 24px rgba(168, 144, 128, 0.08);
            
            /* Card Colors */
            --card-sl-bg: #fff0f0; --card-sl-icon: #e17070;
            --card-al-bg: #eaf6f6; --card-al-icon: #5daaaa;
            --card-ot-bg: #fff6e6; --card-ot-icon: #e6a23c;
            --card-cl-bg: #f3eefc; --card-cl-icon: #9b7fe6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: "Hiragino Sans", "PingFang TC", sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { padding: 12px 20px; padding-top: max(12px, env(safe-area-inset-top)); display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); z-index:10; }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 800; color: var(--primary-dark); letter-spacing: 0.5px; display:flex; align-items:center; gap:8px;}
        .ver-tag { font-size:0.7rem; background:#eee; padding:2px 6px; border-radius:6px; color:#888; font-weight:normal;}
        .status-dot { width:8px; height:8px; border-radius:50%; background:#ccc; transition:0.3s; }
        .status-dot.online { background:#22c55e; box-shadow:0 0 5px #22c55e; }
        .status-dot.offline { background:#ef4444; }
        .header-actions { display: flex; gap: 15px; align-items: center; }
        .btn-icon { background: none; border: none; font-size: 1.2rem; color: var(--primary); cursor: pointer; padding: 5px; position: relative; }
        #dateJumper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        main { flex: 1; overflow-y: auto; padding: 0 16px 100px 16px; }

        /* COMPACT CALENDAR */
        .big-cal-wrapper { background: var(--surface); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); margin-bottom: 15px; }
        .bc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .bc-title { font-weight: 800; font-size: 1rem; color: var(--primary-dark); }
        .bc-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .bc-head { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 2px; font-weight: 600; }
        .bc-day { 
            height: 38px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border-radius: 8px; font-size: 0.9rem; cursor: pointer; position: relative; transition: 0.2s; color: var(--text-main);
        }
        .bc-day.other-month { color: #eee; pointer-events: none; }
        .bc-day.today { background: var(--primary); color: white; }
        .bc-day.selected { border: 2px solid var(--primary); }
        
        .bc-dots { display: flex; gap: 2px; position: absolute; bottom: 3px; }
        .dot { width: 3px; height: 3px; border-radius: 50%; }
        .dot.holiday { background-color: #ef4444; }
        .dot.record { background-color: #8c7b70; }
        .bc-day.today .dot { background-color: white; }

        /* STATS CARDS */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--surface); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: space-between; height: 130px; position: relative; overflow: hidden; }
        .sc-icon-box { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; margin-bottom: 8px; }
        .sc-title { font-size: 0.8rem; font-weight: 700; color: var(--text-main); }
        .sc-val-row { display: flex; align-items: baseline; gap: 4px; margin-top: auto; }
        .sc-val { font-size: 1.5rem; font-weight: 800; color: var(--text-main); }
        .sc-unit { font-size: 0.75rem; color: var(--text-sub); }
        .progress-container { margin-top: 8px; height: 4px; background: #f0f0f0; border-radius: 2px; width: 100%; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 2px; }
        .sc-sub { font-size: 0.65rem; color: var(--text-sub); margin-top: 4px; display: flex; justify-content: space-between; }

        .card-sl .sc-icon-box { background: var(--card-sl-bg); color: var(--card-sl-icon); }
        .card-sl .progress-bar { background: var(--card-sl-icon); }
        .card-al .sc-icon-box { background: var(--card-al-bg); color: var(--card-al-icon); }
        .card-al .progress-bar { background: var(--card-al-icon); }
        .card-ot .sc-icon-box { background: var(--card-ot-bg); color: var(--card-ot-icon); }
        .card-cl .sc-icon-box { background: var(--card-cl-bg); color: var(--card-cl-icon); }
        .card-cl .progress-bar { background: var(--card-cl-icon); }

        .chart-section { background: var(--surface); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); margin-bottom: 15px; border: 1px solid var(--line); }
        .chart-header { font-size: 0.95rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 15px; }
        .chart-wrap { position: relative; height: 200px; width: 100%; }

        /* DAILY LIST */
        .day-header { display: flex; justify-content: space-between; align-items: baseline; margin: 5px 5px 10px 5px; }
        .dh-title { font-size: 1rem; font-weight: 700; color: var(--primary-dark); }
        .dh-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 6px; }
        .badge-work { background: #fff7ed; color: #c2410c; }
        .badge-off { background: #f0fdf4; color: #15803d; }
        .badge-hol { background: #fef2f2; color: #b91c1c; }

        .log-item { display: flex; align-items: center; padding: 14px; background: var(--surface); border-radius: 16px; margin-bottom: 10px; border: 1px solid var(--line); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .log-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 1rem; }
        .icon-ot { background: var(--tag-ot); color: var(--tag-ot-text); }
        .icon-leave { background: var(--tag-off); color: var(--tag-off-text); }
        .log-main { flex: 1; }
        .log-title { font-weight: 700; font-size: 0.95rem; color: var(--text-main); }
        .log-date { font-size: 0.75rem; color: var(--text-sub); margin-top: 2px; }
        .log-val { font-weight: 700; color: var(--primary-dark); font-size: 1rem;}

        /* MODAL */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000;
            visibility: hidden; opacity: 0; transition: opacity 0.3s;
            display: block; 
        }
        .modal-overlay.open { visibility: visible; opacity: 1; }
        .modal-card { 
            position: absolute; bottom: 0; left: 0; right: 0;
            background: var(--surface); 
            border-radius: 30px 30px 0 0; padding: 30px 24px 50px 24px; 
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
            max-height: 90vh; overflow-y: auto; 
        }
        .modal-overlay.open .modal-card { transform: translateY(0); }

        .form-label { font-size: 0.85rem; font-weight: 700; color: var(--text-sub); margin: 15px 0 8px 0; display: block; }
        .form-input { width: 100%; padding: 14px; border: 2px solid var(--line); background: #faf9f7; border-radius: 14px; font-size: 1rem; color: var(--text-main); -webkit-appearance: none; }
        .btn { width: 100%; padding: 15px; border-radius: 14px; border: none; font-weight: 700; font-size: 1rem; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary-dark); color: white; box-shadow: 0 4px 12px rgba(94, 80, 70, 0.2); }
        .btn-outline { background: transparent; border: 2px solid #ef4444; color: #ef4444; margin-top: 10px; }
        .std-hours-group { display: flex; gap: 8px; margin-bottom: 15px; }
        .std-btn { flex: 1; padding: 10px 0; border: 1px solid var(--line); border-radius: 12px; background: #fff; color: var(--text-sub); cursor: pointer; font-size: 0.85rem; transition: 0.2s; text-align: center;}
        .std-btn.active { border-color: var(--primary); background: var(--primary); color: white; }

        .fab { position: fixed; bottom: 90px; right: 24px; width: 58px; height: 58px; border-radius: 20px; background: var(--primary-dark); color: #fff; border: none; font-size: 1.5rem; box-shadow: 0 10px 25px rgba(94, 80, 70, 0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px 0 24px 0; display: flex; justify-content: space-around; border-top: 1px solid var(--line); z-index: 60; }
        .nav-btn { background: none; border: none; color: #ccc; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.7rem; font-weight: 600; cursor: pointer;}
        .nav-btn.active { color: var(--primary-dark); }
        .nav-btn i { font-size: 1.4rem; }

        /* Settings specific */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; }
        .cal-title { font-weight: 700; font-size: 1rem; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .cal-head { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 5px; }
        .cal-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.9rem; cursor: pointer; transition: 0.2s; position: relative; }
        .cal-cell.is-holiday { background: #fee2e2; color: #b91c1c; font-weight: bold; }
        .cal-cell.today { border: 1px solid var(--primary); color: var(--primary); }
        .cal-nav-btn { background:none; border:none; color:var(--primary); font-size:1.2rem; cursor:pointer; }
        .toggle-group { display:flex; gap:10px; }
        .toggle-opt { flex:1; padding:12px; border:2px solid var(--line); border-radius:12px; background:#fff; color:var(--text-sub); font-size:0.9rem; font-weight:600; text-align:center; cursor:pointer; }
        .toggle-opt.active { border-color:var(--primary); color:var(--primary-dark); background:#fdfbf9; }

        /* Rescue Panel */
        .rescue-box { background:#f5f5f5; padding:10px; border-radius:12px; font-family:monospace; font-size:0.8rem; max-height:200px; overflow:auto; margin-top:10px; display:none; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeUp 0.3s; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)} }
        #loadingMask { position:fixed; inset:0; background:var(--bg-body); z-index:2000; display:flex; justify-content:center; align-items:center; flex-direction:column; gap:15px; color:var(--primary); font-weight:bold; transition: opacity 0.5s;}
    </style>
</head>
<body>

    <div id="loadingMask">
        <i class="fa-solid fa-cloud fa-bounce" style="font-size:3rem"></i>
        <span>同步資料庫...</span>
    </div>

    <header>
        <h1>WLB <span class="ver-tag">v3.4</span> <div class="status-dot" id="statusDot"></div></h1>
        <div class="header-actions">
            <button class="btn-icon">
                <i class="fa-solid fa-calendar-days"></i>
                <input type="month" id="dateJumper" onchange="window.app.jumpToDate(this.value)">
            </button>
            <button class="btn-icon" onclick="window.app.openSettings()"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <main>
        <div id="tab-home" class="tab-content active">
            <div class="big-cal-wrapper">
                <div class="bc-header">
                    <button class="btn-icon" onclick="window.app.navMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="bc-title" id="bcTitle"></div>
                    <button class="btn-icon" onclick="window.app.navMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="bc-grid">
                    <div class="bc-head">日</div><div class="bc-head">一</div><div class="bc-head">二</div><div class="bc-head">三</div><div class="bc-head">四</div><div class="bc-head">五</div><div class="bc-head">六</div>
                </div>
                <div class="bc-grid" id="bcBody"></div>
            </div>

            <div class="day-header">
                <div class="dh-title" id="dateTitleLabel"></div>
                <div id="dateStatusBadge"></div>
            </div>
            <div id="dayRecords"></div>
        </div>

        <div id="tab-stats" class="tab-content">
            <h3 style="margin-bottom:15px; color:var(--text-main)">數據概覽</h3>
            <div class="stats-grid">
                <div class="stat-card card-sl">
                    <div class="sc-icon-box"><i class="fa-solid fa-notes-medical"></i></div>
                    <div class="sc-title">病假 (SL)</div>
                    <div class="sc-val-row"><span class="sc-val" id="cardSL_Rem">--</span><span class="sc-unit">天</span></div>
                    <div><div class="progress-container"><div class="progress-bar" id="barSL" style="width:0%"></div></div><div class="sc-sub"><span>已用 <span id="cardSL_Used">0</span></span><span>累積 <span id="cardSL_Total">0</span></span></div></div>
                </div>
                <div class="stat-card card-al">
                    <div class="sc-icon-box"><i class="fa-solid fa-umbrella-beach"></i></div>
                    <div class="sc-title">年假 (AL)</div>
                    <div class="sc-val-row"><span class="sc-val" id="cardAL_Rem">--</span><span class="sc-unit">天</span></div>
                    <div><div class="progress-container"><div class="progress-bar" id="barAL" style="width:0%"></div></div><div class="sc-sub"><span>已用 <span id="cardAL_Used">0</span></span><span>年額 <span id="cardAL_Total">0</span></span></div></div>
                </div>
