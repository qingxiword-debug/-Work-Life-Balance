<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Work-Life Balance v2.9</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* Palette: Gentle Milk Tea */
            --bg-body: #fbf9f6; 
            --surface: #ffffff;
            --primary: #a89080; 
            --primary-dark: #6d5b50;
            --text-main: #4a403a; 
            --text-sub: #9e948d; 
            --line: #f0ebe5;
            
            --tag-ot: #f5f0eb; --tag-ot-text: #8c7b70;
            --tag-off: #edf2ed; --tag-off-text: #6b8c6e;
            
            --radius: 20px; 
            --shadow: 0 4px 24px rgba(168, 144, 128, 0.08);
            
            /* Card Colors (Subtle) */
            --card-sl-bg: #fff0f0; --card-sl-icon: #e17070;
            --card-al-bg: #eaf6f6; --card-al-icon: #5daaaa;
            --card-ot-bg: #fff6e6; --card-ot-icon: #e6a23c;
            --card-cl-bg: #f3eefc; --card-cl-icon: #9b7fe6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: "Hiragino Sans", "PingFang TC", sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header */
        header { padding: 15px 24px; padding-top: max(15px, env(safe-area-inset-top)); display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); z-index:10; }
        h1 { margin: 0; font-size: 1.3rem; font-weight: 800; color: var(--primary-dark); letter-spacing: 0.5px; display:flex; align-items:center; gap:8px;}
        .ver-tag { font-size:0.7rem; background:#eee; padding:2px 6px; border-radius:6px; color:#888; font-weight:normal;}
        .status-dot { width:8px; height:8px; border-radius:50%; background:#ccc; transition:0.3s; }
        .status-dot.online { background:#22c55e; box-shadow:0 0 5px #22c55e; }
        .status-dot.offline { background:#ef4444; }
        .btn-icon { background: none; border: none; font-size: 1.2rem; color: var(--primary); cursor: pointer; padding: 5px; }

        /* Main Scroll Area */
        main { flex: 1; overflow-y: auto; padding: 0 20px 100px 20px; }

        /* --- BIG CALENDAR (Home) --- */
        .big-cal-wrapper { background: var(--surface); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .bc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .bc-title { font-weight: 800; font-size: 1.1rem; color: var(--primary-dark); }
        .bc-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .bc-head { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 5px; font-weight: 600; }
        .bc-day { 
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border-radius: 12px; font-size: 0.95rem; cursor: pointer; position: relative; transition: 0.2s; color: var(--text-main);
        }
        .bc-day.other-month { color: #e0e0e0; pointer-events: none; }
        .bc-day.today { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(168,144,128,0.4); }
        .bc-day.selected { border: 2px solid var(--primary); }
        
        /* Dots in Calendar */
        .bc-dots { display: flex; gap: 3px; position: absolute; bottom: 6px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; }
        .dot.holiday { background-color: #ef4444; }
        .dot.record { background-color: #8c7b70; }
        .bc-day.today .dot { background-color: white; }

        /* --- STATS GRID (Dashboard) --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--surface); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: space-between; height: 140px; position: relative; overflow: hidden; }
        
        .sc-icon-box { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-bottom: 10px; }
        .sc-title { font-size: 0.85rem; font-weight: 700; color: var(--text-main); }
        .sc-val-row { display: flex; align-items: baseline; gap: 4px; margin-top: auto; }
        .sc-val { font-size: 1.6rem; font-weight: 800; color: var(--text-main); }
        .sc-unit { font-size: 0.8rem; color: var(--text-sub); }
        
        .progress-container { margin-top: 8px; height: 4px; background: #f0f0f0; border-radius: 2px; width: 100%; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 2px; }
        .sc-sub { font-size: 0.7rem; color: var(--text-sub); margin-top: 4px; display: flex; justify-content: space-between; }

        /* Colors for Cards */
        .card-sl .sc-icon-box { background: var(--card-sl-bg); color: var(--card-sl-icon); }
        .card-sl .progress-bar { background: var(--card-sl-icon); }
        .card-al .sc-icon-box { background: var(--card-al-bg); color: var(--card-al-icon); }
        .card-al .progress-bar { background: var(--card-al-icon); }
        .card-ot .sc-icon-box { background: var(--card-ot-bg); color: var(--card-ot-icon); }
        .card-cl .sc-icon-box { background: var(--card-cl-bg); color: var(--card-cl-icon); }
        .card-cl .progress-bar { background: var(--card-cl-icon); }

        /* Daily List */
        .day-header { display: flex; justify-content: space-between; align-items: baseline; margin: 0 5px 10px 5px; }
        .dh-title { font-size: 1rem; font-weight: 700; color: var(--primary-dark); }
        .dh-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 6px; }
        .badge-work { background: #fff7ed; color: #c2410c; }
        .badge-off { background: #f0fdf4; color: #15803d; }
        .badge-hol { background: #fef2f2; color: #b91c1c; }

        .log-item { display: flex; align-items: center; padding: 14px; background: var(--surface); border-radius: 16px; margin-bottom: 10px; border: 1px solid var(--line); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .log-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 1rem; }
        .icon-ot { background: var(--tag-ot); color: var(--tag-ot-text); }
        .icon-leave { background: var(--tag-off); color: var(--tag-off-text); }
        .log-main { flex: 1; }
        .log-title { font-weight: 700; font-size: 0.95rem; color: var(--text-main); }
        .log-date { font-size: 0.75rem; color: var(--text-sub); margin-top: 2px; }
        .log-val { font-weight: 700; color: var(--primary-dark); font-size: 1rem;}

        /* Modal & Forms */
        .modal-overlay { position: fixed; inset: 0; background: rgba(74, 64, 58, 0.5); backdrop-filter: blur(4px); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: flex-end; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-card { background: var(--surface); width: 100%; border-radius: 30px 30px 0 0; padding: 30px 24px 50px 24px; transform: translateY(100%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1); max-height: 90vh; overflow-y: auto; }
        
        .form-label { font-size: 0.85rem; font-weight: 700; color: var(--text-sub); margin: 15px 0 8px 0; display: block; }
        .form-input { width: 100%; padding: 14px; border: 2px solid var(--line); background: #faf9f7; border-radius: 14px; font-size: 1rem; color: var(--text-main); -webkit-appearance: none; }
        .btn { width: 100%; padding: 15px; border-radius: 14px; border: none; font-weight: 700; font-size: 1rem; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: var(--primary-dark); color: white; box-shadow: 0 4px 12px rgba(94, 80, 70, 0.2); }
        .btn-outline { background: transparent; border: 2px solid #ef4444; color: #ef4444; margin-top: 10px; }

        .std-hours-group { display: flex; gap: 8px; margin-bottom: 15px; }
        .std-btn { flex: 1; padding: 10px 0; border: 1px solid var(--line); border-radius: 12px; background: #fff; color: var(--text-sub); cursor: pointer; font-size: 0.85rem; transition: 0.2s; text-align: center;}
        .std-btn.active { border-color: var(--primary); background: var(--primary); color: white; }

        /* Nav & FAB */
        .fab { position: fixed; bottom: 90px; right: 24px; width: 58px; height: 58px; border-radius: 20px; background: var(--primary-dark); color: #fff; border: none; font-size: 1.5rem; box-shadow: 0 10px 25px rgba(94, 80, 70, 0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px 0 24px 0; display: flex; justify-content: space-around; border-top: 1px solid var(--line); z-index: 60; }
        .nav-btn { background: none; border: none; color: #ccc; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.7rem; font-weight: 600; cursor: pointer;}
        .nav-btn.active { color: var(--primary-dark); }
        .nav-btn i { font-size: 1.4rem; }

        /* Settings specific */
        .holiday-list { max-height: 150px; overflow-y: auto; background: #faf9f7; border-radius: 12px; padding: 10px; border: 1px solid var(--line); }
        .holiday-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .toggle-group { display:flex; gap:10px; }
        .toggle-opt { flex:1; padding:12px; border:2px solid var(--line); border-radius:12px; background:#fff; color:var(--text-sub); font-size:0.9rem; font-weight:600; text-align:center; cursor:pointer; }
        .toggle-opt.active { border-color:var(--primary); color:var(--primary-dark); background:#fdfbf9; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeUp 0.3s; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)} }
        #loadingMask { position:fixed; inset:0; background:var(--bg-body); z-index:2000; display:flex; justify-content:center; align-items:center; flex-direction:column; gap:15px; color:var(--primary); font-weight:bold; transition: opacity 0.5s;}
    </style>
</head>
<body>

    <div id="loadingMask">
        <i class="fa-solid fa-cloud fa-bounce" style="font-size:3rem"></i>
        <span>同步私人資料庫...</span>
    </div>

    <header>
        <h1>WLB <span class="ver-tag">v2.9</span> <div class="status-dot" id="statusDot"></div></h1>
        <div class="header-actions">
            <button class="btn-icon" onclick="window.app.openSettings()"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <main>
        <div id="tab-home" class="tab-content active">
            
            <div class="big-cal-wrapper">
                <div class="bc-header">
                    <button class="btn-icon" onclick="window.app.navMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="bc-title" id="bcTitle"></div>
                    <button class="btn-icon" onclick="window.app.navMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="bc-grid">
                    <div class="bc-head">日</div><div class="bc-head">一</div><div class="bc-head">二</div><div class="bc-head">三</div><div class="bc-head">四</div><div class="bc-head">五</div><div class="bc-head">六</div>
                </div>
                <div class="bc-grid" id="bcBody"></div>
            </div>

            <div class="day-header">
                <div class="dh-title" id="dateTitleLabel"></div>
                <div id="dateStatusBadge"></div>
            </div>
            <div id="dayRecords"></div>
        </div>

        <div id="tab-stats" class="tab-content">
            <h3 style="margin-bottom:15px">數據概覽</h3>
            <div class="stats-grid">
                <div class="stat-card card-sl">
                    <div class="sc-icon-box"><i class="fa-solid fa-notes-medical"></i></div>
                    <div class="sc-title">病假 (Sick Leave)</div>
                    <div class="sc-val-row">
                        <span class="sc-val" id="cardSL_Rem">--</span><span class="sc-unit">天</span>
                    </div>
                    <div>
                        <div class="progress-container"><div class="progress-bar" id="barSL" style="width:0%"></div></div>
                        <div class="sc-sub"><span>已用 <span id="cardSL_Used">0</span></span><span>累積 <span id="cardSL_Total">0</span></span></div>
                    </div>
                </div>
                <div class="stat-card card-al">
                    <div class="sc-icon-box"><i class="fa-solid fa-umbrella-beach"></i></div>
                    <div class="sc-title">年假 (Annual)</div>
                    <div class="sc-val-row">
                        <span class="sc-val" id="cardAL_Rem">--</span><span class="sc-unit">天</span>
                    </div>
                    <div>
                        <div class="progress-container"><div class="progress-bar" id="barAL" style="width:0%"></div></div>
                        <div class="sc-sub"><span>已用 <span id="cardAL_Used">0</span></span><span>年額 <span id="cardAL_Total">0</span></span></div>
                    </div>
                </div>
                <div class="stat-card card-ot">
                    <div class="sc-icon-box"><i class="fa-solid fa-briefcase"></i></div>
                    <div class="sc-title">OT 時數</div>
                    <div class="sc-val-row">
                        <span class="sc-val" id="cardOT_Hours">--</span><span class="sc-unit">h</span>
                    </div>
                    <div class="sc-sub" style="margin-top:10px">累計加班總時數</div>
                </div>
                <div class="stat-card card-cl">
                    <div class="sc-icon-box"><i class="fa-solid fa-calendar-check"></i></div>
                    <div class="sc-title">OT 補假</div>
                    <div class="sc-val-row">
                        <span class="sc-val" id="cardCL_Rem">--</span><span class="sc-unit">天</span>
                    </div>
                    <div>
                        <div class="progress-container"><div class="progress-bar" id="barCL" style="width:0%"></div></div>
                        <div class="sc-sub"><span>已抵扣 <span id="cardCL_Used">0</span></span><span>可換 <span id="cardCL_Total">0</span></span></div>
                    </div>
                </div>
            </div>
            <p style="font-size:0.75rem; color:var(--text-sub); text-align:center;">* 系統優先扣除 OT 補假，不足時才扣年假 (9/1 重置)</p>
        </div>

        <div id="tab-logs" class="tab-content">
            <h3>歷史紀錄</h3>
            <div id="fullList"></div>
        </div>
    </main>

    <button class="fab" onclick="window.app.triggerAdd()"><i class="fa-solid fa-plus"></i></button>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="window.app.switchTab('home')" id="nav-home"><i class="fa-solid fa-calendar-days"></i> 日程</button>
        <button class="nav-btn" onclick="window.app.switchTab('stats')" id="nav-stats"><i class="fa-solid fa-chart-simple"></i> 統計</button>
        <button class="nav-btn" onclick="window.app.switchTab('logs')" id="nav-logs"><i class="fa-solid fa-list"></i> 紀錄</button>
    </nav>

    <div class="modal-overlay" id="setModal" onclick="if(event.target===this) document.getElementById('setModal').classList.remove('open')">
        <div class="modal-card">
            <h3 style="margin-top:0">設定</h3>
            <label class="form-label">工作模式</label>
            <div class="toggle-group">
                <div class="toggle-opt" id="modeMonFri" onclick="window.app.setWorkMode('mon_fri')">一至五</div>
                <div class="toggle-opt" id="modeAltSat" onclick="window.app.setWorkMode('alt_sat')">長短週</div>
            </div>
            <div id="satSetting" style="display:none; margin-top:10px;">
                <label class="form-label">長短週基準日 (上班的週六)</label>
                <input type="date" class="form-input" id="setBaseSat">
            </div>
            
            <label class="form-label">假期設定 (點擊紅日管理)</label>
            <div style="background:#faf9f7; padding:10px; border-radius:12px; border:1px solid var(--line); margin-bottom:15px; text-align:center;">
                <i class="fa-solid fa-calendar-xmark" style="color:var(--primary)"></i> 
                <span style="font-size:0.9rem; margin-left:5px" onclick="alert('請直接在首頁日曆點擊日期來設定假期')">請在首頁日曆點擊設定</span>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div><label class="form-label">年假額度 (每年)</label><input type="number" class="form-input" id="setAL"></div>
                <div><label class="form-label">日工時 (換算用)</label><input type="number" class="form-input" id="setDaily"></div>
            </div>
            <label class="form-label">入職日期 (計算病假)</label>
            <input type="date" class="form-input" id="setJoinDate">
            
            <button class="btn btn-primary" onclick="window.app.saveSettings(this)">儲存設定</button>
        </div>
    </div>

    <div class="modal-overlay" id="recModal" onclick="if(event.target===this) window.app.closeModal()">
        <div class="modal-card">
            <h3 id="modalDateTitle" style="margin-top:0">新紀錄</h3>
            <form id="recForm" onsubmit="window.app.saveRecord(event)">
                <input type="hidden" id="editId"><input type="hidden" id="recType" value="OT">
                
                <label class="form-label" style="margin-top:0">日期</label>
                <input type="date" class="form-input" id="inpDate" required onchange="window.app.onModalDateChange(this.value)">

                <div style="display:flex; background:#faf9f7; padding:5px; border-radius:18px; margin:20px 0; border:1px solid var(--line);">
                    <button type="button" id="btnTypeOT" class="btn" style="margin:0; background:white; color:var(--primary-dark); box-shadow:0 2px 8px rgba(0,0,0,0.05);" onclick="window.app.setType('OT')">加班 OT</button>
                    <button type="button" id="btnTypeLeave" class="btn" style="margin:0; background:transparent; color:var(--text-sub); box-shadow:none;" onclick="window.app.setType('Leave')">請假</button>
                </div>
                
                <div id="secOT">
                    <label class="form-label">扣除工時</label>
                    <div class="std-hours-group">
                        <button type="button" class="std-btn active" id="btnStd9" onclick="window.app.setStdHours(9)">9h</button>
                        <button type="button" class="std-btn" id="btnStd8" onclick="window.app.setStdHours(8)">8h</button>
                        <button type="button" class="std-btn" id="btnStd4" onclick="window.app.setStdHours(4)">4h</button>
                        <button type="button" class="std-btn" id="btnStd0" onclick="window.app.setStdHours(0)">0h</button>
                    </div>
                    <input type="number" id="inpStdVal" value="9" style="display:none;"> 

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div><label class="form-label">上班</label><input type="time" class="form-input" id="inpIn" onchange="window.app.calcOT()"></div>
                        <div><label class="form-label">下班</label><input type="time" class="form-input" id="inpOut" onchange="window.app.calcOT()"></div>
                    </div>
                    <div id="otMsg" style="text-align:right; font-size:0.8rem; color:var(--primary); margin-top:8px; height:1.2em;"></div>
                    <label class="form-label">OT 時數</label><input type="number" step="0.1" class="form-input" id="inpHours" placeholder="結果">
                </div>

                <div id="secLeave" style="display:none;">
                    <label class="form-label">假別</label>
                    <select class="form-input" id="inpLeaveType"><option value="AL">年假/補假 (AL)</option><option value="SL">病假 (SL)</option></select>
                    <label class="form-label">天數</label><input type="number" step="0.5" class="form-input" id="inpDays" value="1">
                    <p style="font-size:0.75rem; color:var(--text-sub); margin-top:5px">系統將優先扣除 OT 補假，不足時扣年假。</p>
                </div>
                <label class="form-label">備註</label><input type="text" class="form-input" id="inpNote">
                
                <div style="margin-top:20px; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="chkIsHoliday" style="width:20px; height:20px;">
                    <label for="chkIsHoliday" style="font-size:0.9rem; color:var(--text-main)">設為假期 (紅日)</label>
                </div>

                <button type="submit" class="btn btn-primary">儲存</button>
                <button type="button" class="btn btn-outline" style="display:none;" id="btnDel" onclick="window.app.delRecord(this)">刪除</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAi_iDY4JeppmveW5-Uq2cMRWJY9jeT9Dw",
            authDomain: "work-life-balance-9f09b.firebaseapp.com",
            projectId: "work-life-balance-9f09b",
            storageBucket: "work-life-balance-9f09b.firebasestorage.app",
            messagingSenderId: "869347289477",
            appId: "1:869347289477:web:c2bee07bc2aeb92973bcec",
            measurementId: "G-94EXTK7W8Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "worklife_app", "personal_data_v2");

        const PRESET_HOLIDAYS = [
            {date:"2025-01-01",name:"元旦"},{date:"2025-01-29",name:"農曆年初一"},{date:"2025-01-30",name:"農曆年初二"},{date:"2025-01-31",name:"農曆年初三"},{date:"2025-04-04",name:"清明節"},{date:"2025-04-18",name:"耶穌受難節"},{date:"2025-04-19",name:"耶穌受難節翌日"},{date:"2025-04-21",name:"復活節星期一"},{date:"2025-05-01",name:"勞動節"},{date:"2025-05-05",name:"佛誕"},{date:"2025-05-31",name:"端午節"},{date:"2025-07-01",name:"香港特別行政區成立紀念日"},{date:"2025-10-01",name:"國慶日"},{date:"2025-10-07",name:"中秋節翌日"},{date:"2025-10-29",name:"重陽節"},{date:"2025-12-25",name:"聖誕節"},{date:"2025-12-26",name:"聖誕節後第一個周日"},
            {date:"2026-01-01",name:"元旦"},{date:"2026-02-17",name:"農曆年初一"},{date:"2026-02-18",name:"農曆年初二"},{date:"2026-02-19",name:"農曆年初三"},{date:"2026-04-03",name:"耶穌受難節"},{date:"2026-04-04",name:"耶穌受難節翌日"},{date:"2026-04-06",name:"清明節翌日"},{date:"2026-04-07",name:"復活節星期一翌日"},{date:"2026-05-01",name:"勞動節"},{date:"2026-05-25",name:"佛誕翌日"},{date:"2026-06-19",name:"端午節"},{date:"2026-07-01",name:"香港特別行政區成立紀念日"},{date:"2026-09-26",name:"中秋節翌日"},{date:"2026-10-01",name:"國慶日"},{date:"2026-10-19",name:"重陽節翌日"},{date:"2026-12-25",name:"聖誕節"},{date:"2026-12-26",name:"聖誕節後第一個周日"}
        ];

        let localData = {
            records: [],
            settings: { 
                workMode: "alt_sat", baseSat: "2025-09-13", joinDate: "2024-09-01", 
                holidays: PRESET_HOLIDAYS, alBalance: 14, dailyHours: 8 
            }
        };
        let selectedDate = new Date();
        let calViewDate = new Date(); // For Big Calendar Month View
        let curType = 'OT';
        let editId = null;

        onSnapshot(docRef, (docSnap) => {
            const loading = document.getElementById('loadingMask');
            const dot = document.getElementById('statusDot');
            if (docSnap.exists()) {
                const data = docSnap.data();
                if(!data.settings.workMode) data.settings.workMode = 'alt_sat';
                if(data.settings.holidays.length && typeof data.settings.holidays[0] === 'string') {
                    data.settings.holidays = PRESET_HOLIDAYS;
                }
                localData = data;
                dot.className = 'status-dot online';
                refreshApp();
            } else { setDoc(docRef, localData); dot.className = 'status-dot online'; }
            if(loading) { loading.style.opacity = '0'; setTimeout(()=>loading.style.display='none', 500); }
        }, (err) => { document.getElementById('statusDot').className = 'status-dot offline'; document.getElementById('loadingMask').style.display='none'; });

        window.app = {
            openSettings: () => {
                document.getElementById('setModal').classList.add('open');
                const s = localData.settings;
                window.app.setWorkMode(s.workMode || 'alt_sat');
                document.getElementById('setBaseSat').value = s.baseSat || '';
                document.getElementById('setJoinDate').value = s.joinDate || '';
                document.getElementById('setAL').value = s.alBalance;
                document.getElementById('setDaily').value = s.dailyHours;
            },
            setWorkMode: (mode) => {
                localData.settings.workMode = mode;
                document.getElementById('modeMonFri').className = `toggle-opt ${mode==='mon_fri'?'active':''}`;
                document.getElementById('modeAltSat').className = `toggle-opt ${mode==='alt_sat'?'active':''}`;
                document.getElementById('satSetting').style.display = mode==='alt_sat' ? 'block' : 'none';
            },
            saveSettings: async (btn) => {
                const originalText = btn.innerText;
                btn.innerText = "⏳ 儲存中..."; btn.disabled = true;
                try {
                    const s = localData.settings;
                    s.baseSat = document.getElementById('setBaseSat').value;
                    s.joinDate = document.getElementById('setJoinDate').value;
                    s.alBalance = Number(document.getElementById('setAL').value);
                    s.dailyHours = Number(document.getElementById('setDaily').value);
                    await pushToCloud();
                    document.getElementById('setModal').classList.remove('open');
                    alert("✅ 設定已儲存！");
                } catch(e) { alert("❌ 錯誤：" + e.message); }
                finally { btn.innerText = originalText; btn.disabled = false; }
            },
            
            triggerAdd: () => openModal(),
            closeModal: () => document.getElementById('recModal').classList.remove('open'),
            switchTab: (t) => {
                document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
                document.getElementById(`tab-${t}`).classList.add('active');
                document.getElementById(`nav-${t}`).classList.add('active');
                if(t==='stats') updateStats();
            },
            setType: (t) => setType(t), 
            setStdHours: (h) => {
                document.getElementById('inpStdVal').value = h;
                document.querySelectorAll('.std-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('btnStd'+h).classList.add('active');
                window.app.calcOT();
            },
            calcOT: () => calcOT(), 
            saveRecord: (e) => saveRecord(e), delRecord: (b) => delRecord(b), 
            
            // Big Calendar Logic
            navMonth: (dir) => {
                calViewDate.setMonth(calViewDate.getMonth() + dir);
                renderBigCalendar();
            },
            selectDate: (d) => selectDate(d),
            onModalDateChange: (val) => {
                if(!val) return;
                const d = new Date(val);
                const status = getDayStatus(d);
                let defaultStd = 9; 
                if(status.isOff) defaultStd = 0; 
                else if(status.type === 'WORK_SAT') defaultStd = 4;
                window.app.setStdHours(defaultStd);
            }
        };

        async function pushToCloud() { await setDoc(docRef, localData); }

        function getDayStatus(d) {
            const dStr = d.toISOString().split('T')[0];
            const s = localData.settings;
            const hol = s.holidays.find(h=>h.date===dStr);
            if(hol) return { type: 'HOLIDAY', name: hol.name, isOff: true };
            if(d.getDay()===0) return { type: 'OFF', name: '週日', isOff: true };
            if(d.getDay()===6) {
                if(s.workMode==='mon_fri') return { type: 'OFF', name: '週六(休)', isOff: true };
                if(!s.baseSat) return { type: 'OFF', name: '週六', isOff: true }; 
                const base = new Date(s.baseSat); const target = new Date(dStr);
                if(target < base) return { type: 'OFF', name: '週六', isOff: true };
                let cnt = 0, curr = new Date(base);
                while(curr <= target) {
                    const cStr = curr.toISOString().split('T')[0];
                    if(!s.holidays.some(h=>h.date===cStr)) { if(cStr===dStr) break; cnt++; }
                    curr.setDate(curr.getDate()+7);
                }
                return (cnt%2===0) ? { type: 'WORK_SAT', name: '長週上班', isOff: false } : { type: 'OFF', name: '短週休假', isOff: true };
            }
            return { type: 'WORK', name: '工作日', isOff: false };
        }

        function refreshApp() {
            renderBigCalendar();
            const dStr = selectedDate.toISOString().split('T')[0];
            const status = getDayStatus(selectedDate);
            const badgeClass = status.isOff ? (status.type==='HOLIDAY'?'badge-hol':'badge-off') : 'badge-work';
            const statusText = status.isOff ? (status.type==='HOLIDAY'?status.name:'休假') : '上班';
            
            document.getElementById('dateTitleLabel').innerHTML = dStr;
            document.getElementById('dateStatusBadge').innerHTML = `<span class="dh-badge ${badgeClass}">${statusText}</span>`;

            const recs = localData.records.filter(r => r.date === dStr);
            document.getElementById('dayRecords').innerHTML = recs.length ? recs.map(renderItem).join('') : `<div style="text-align:center;padding:30px;color:#ccc;background:#faf9f7;border-radius:16px;border:1px solid #eee"><div style="font-size:0.9rem">無紀錄</div></div>`;
            updateStats(); renderAllLogs();
        }

        function renderBigCalendar() {
            const grid = document.getElementById('bcBody'); grid.innerHTML = '';
            const y = calViewDate.getFullYear(), m = calViewDate.getMonth();
            document.getElementById('bcTitle').innerText = `${y}年 ${m+1}月`;
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m+1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];
            const selStr = selectedDate.toISOString().split('T')[0];

            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';

            for(let i=1; i<=daysInMonth; i++) {
                const date = new Date(y, m, i);
                const dStr = date.toISOString().split('T')[0];
                const status = getDayStatus(date);
                const recs = localData.records.filter(r => r.date === dStr);
                
                const el = document.createElement('div');
                el.className = `bc-day ${dStr===todayStr?'today':''} ${dStr===selStr?'selected':''}`;
                if(status.type === 'HOLIDAY') el.style.color = '#ef4444';
                
                let dotHtml = '';
                if(status.type === 'HOLIDAY') dotHtml += '<div class="dot holiday"></div>';
                if(recs.length > 0) dotHtml += '<div class="dot record"></div>';
                
                el.innerHTML = `<span>${i}</span><div class="bc-dots">${dotHtml}</div>`;
                el.onclick = () => window.app.selectDate(date);
                grid.appendChild(el);
            }
        }

        function selectDate(d) {
            selectedDate = d;
            // Sync calendar view if jumping
            if(d.getMonth() !== calViewDate.getMonth()) calViewDate = new Date(d);
            refreshApp();
        }

        function renderAllLogs() {
            const sorted = [...localData.records].sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('fullList').innerHTML = sorted.map(renderItem).join('');
        }
        function renderItem(r) {
            const isOT = r.type === 'OT';
            return `<div class="log-item" onclick="window.appSelectRecord(${r.id})"><div class="log-icon ${isOT?'icon-ot':'icon-leave'}"><i class="fa-solid ${isOT?'fa-clock':'fa-mug-hot'}"></i></div><div class="log-main"><div class="log-title">${isOT?'OT 加班' : (r.subType==='AL'?'年假 (AL)':'病假 (SL)')}</div><div class="log-date">${r.date} ${r.note?'· '+r.note:''}</div></div><div class="log-val">${isOT ? '+'+r.val+'h' : '-'+r.val+'天'}</div></div>`;
        }
        window.appSelectRecord = (id) => { const r = localData.records.find(item => item.id === id); if(r) openModal(r); };

        function updateStats() {
            const s = localData.settings;
            const now = new Date();
            
            // 1. SL Calculation (Cumulative since join)
            const joinD = s.joinDate ? new Date(s.joinDate) : new Date(); 
            let months = (now.getFullYear() - joinD.getFullYear()) * 12 + (now.getMonth() - joinD.getMonth());
            if(now.getDate() < joinD.getDate()) months--;
            const totalSL = Math.max(0, months * 2);
            const usedSL = localData.records.filter(r=>r.type==='Leave'&&r.subType==='SL').reduce((a,b)=>a+Number(b.val),0);
            
            document.getElementById('cardSL_Total').innerText = totalSL;
            document.getElementById('cardSL_Used').innerText = usedSL;
            const remSL = totalSL - usedSL;
            document.getElementById('cardSL_Rem').innerText = remSL;
            document.getElementById('barSL').style.width = (totalSL > 0 ? (usedSL/totalSL)*100 : 0) + '%';

            // 2. OT Calculation
            const totalOTHours = localData.records.filter(r=>r.type==='OT').reduce((a,b)=>a+Number(b.val),0);
            document.getElementById('cardOT_Hours').innerText = totalOTHours.toFixed(1);
            
            // 3. Comp Leave Logic (Smart Deduction)
            const dailyHours = s.dailyHours || 8;
            const earnedCompDays = totalOTHours / dailyHours; // Total potential days from OT
            
            // Filter AL usage for CURRENT year (Sept 1 - Aug 31)
            let currentYear = now.getFullYear();
            if(now.getMonth() < 8) currentYear--; // Before Sept, use prev year
            const startAL = new Date(currentYear, 8, 1); // Sept 1
            
            const vacationRecords = localData.records.filter(r => 
                r.type==='Leave' && r.subType==='AL' && new Date(r.date) >= startAL
            );
            const totalVacationTaken = vacationRecords.reduce((a,b)=>a+Number(b.val),0);

            // Logic: Deduct from Comp Leave first, then AL
            let usedComp = 0;
            let usedAL = 0;

            if(totalVacationTaken <= earnedCompDays) {
                usedComp = totalVacationTaken;
                usedAL = 0;
            } else {
                usedComp = earnedCompDays;
                usedAL = totalVacationTaken - earnedCompDays;
            }

            // Render Comp Leave Card
            document.getElementById('cardCL_Total').innerText = earnedCompDays.toFixed(1);
            document.getElementById('cardCL_Used').innerText = usedComp.toFixed(1);
            document.getElementById('cardCL_Rem').innerText = (earnedCompDays - usedComp).toFixed(1);
            document.getElementById('barCL').style.width = (earnedCompDays > 0 ? (usedComp/earnedCompDays)*100 : 0) + '%';

            // Render AL Card
            const totalAL = s.alBalance; // Yearly quota
            document.getElementById('cardAL_Total').innerText = totalAL;
            document.getElementById('cardAL_Used').innerText = usedAL.toFixed(1);
            document.getElementById('cardAL_Rem').innerText = (totalAL - usedAL).toFixed(1);
            document.getElementById('barAL').style.width = (totalAL > 0 ? (usedAL/totalAL)*100 : 0) + '%';
        }
        
        function openModal(r = null) {
            document.getElementById('recModal').classList.add('open');
            const dStr = selectedDate.toISOString().split('T')[0];
            document.getElementById('inpDate').value = dStr;
            window.app.onModalDateChange(dStr); 

            if(r) { 
                editId=r.id; 
                document.getElementById('inpDate').value = r.date;
                document.getElementById('inpNote').value=r.note||''; 
                
                // Holiday Checkbox Logic
                const isHoliday = localData.settings.holidays.some(h=>h.date===r.date);
                document.getElementById('chkIsHoliday').checked = isHoliday;

                setType(r.type); 
                if(r.type==='OT') document.getElementById('inpHours').value=r.val; 
                else{ document.getElementById('inpLeaveType').value=r.subType; document.getElementById('inpDays').value=r.val; } 
                document.getElementById('btnDel').style.display='block'; 
                window.app.onModalDateChange(r.date);
            } else { 
                editId=null; 
                document.getElementById('recForm').reset(); 
                document.getElementById('inpDate').value = dStr;
                // Check if current date is holiday
                const isHoliday = localData.settings.holidays.some(h=>h.date===dStr);
                document.getElementById('chkIsHoliday').checked = isHoliday;

                setType('OT'); 
                document.getElementById('btnDel').style.display='none';
                window.app.onModalDateChange(dStr);
            }
        }
        
        function setType(t) { curType = t; document.getElementById('recType').value = t; document.getElementById('secOT').style.display = t==='OT'?'block':'none'; document.getElementById('secLeave').style.display = t==='Leave'?'block':'none'; }
        
        function calcOT() {
            const i=document.getElementById('inpIn').value;
            const o=document.getElementById('inpOut').value;
            if(!i||!o) return;
            const mi = i.split(':').reduce((h,m)=>h*60+Number(m),0);
            const mo = o.split(':').reduce((h,m)=>h*60+Number(m),0);
            const stdHours = Number(document.getElementById('inpStdVal').value);
            let durationMins = mo - mi;
            if(durationMins < 0) durationMins += 24*60; 
            const otMins = Math.max(0, durationMins - (stdHours * 60));
            document.getElementById('inpHours').value = (otMins / 60).toFixed(1);
            document.getElementById('otMsg').innerText = `總工時 ${(durationMins/60).toFixed(1)}h - 扣除 ${stdHours}h`;
        }
        
        async function saveRecord(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "⏳..."; btn.disabled = true;
            try {
                const dateVal = document.getElementById('inpDate').value;
                if(!dateVal) throw new Error("請選擇日期");

                // Handle Holiday Checkbox
                const isHolidayCheck = document.getElementById('chkIsHoliday').checked;
                const holIndex = localData.settings.holidays.findIndex(h=>h.date===dateVal);
                if(isHolidayCheck) {
                    if(holIndex === -1) localData.settings.holidays.push({date: dateVal, name: "自訂假期"});
                } else {
                    if(holIndex !== -1) localData.settings.holidays.splice(holIndex, 1);
                }

                const val = curType==='OT' ? document.getElementById('inpHours').value : document.getElementById('inpDays').value;
                if(!val) throw new Error("請輸入數值");
                
                const rec = { id: editId||Date.now(), date: dateVal, type: curType, subType: curType==='Leave'?document.getElementById('inpLeaveType').value:null, val: val, note: document.getElementById('inpNote').value };
                
                if(editId) localData.records = localData.records.filter(r=>r.id!==editId);
                localData.records.push(rec); 
                
                await pushToCloud(); 
                alert("✅ 成功！"); 
                window.app.closeModal();
                
                // Refresh
                if(new Date(dateVal).getMonth() !== calViewDate.getMonth()) {
                    calViewDate = new Date(dateVal);
                }
                window.app.selectDate(new Date(dateVal));

            } catch(err) { alert("❌ " + err.message); }
            finally { btn.innerText = originalText; btn.disabled = false; }
        }
        
        async function delRecord(btn) { 
            if(editId && confirm("刪除此紀錄？")) { 
                try { localData.records = localData.records.filter(r=>r.id!==editId); await pushToCloud(); window.app.closeModal(); } 
                catch(e){ alert("刪除失敗"); }
            } 
        }
        
        setTimeout(()=> {
            refreshApp();
        }, 500);
    </script>
</body>
</html>
